<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog/1.9"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog/1.9
                  http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-1.9.xsd">
<!--
    See http://www.liquibase.org/manual/home#available_database_refactorings
    for a list of supported elements and attributes
-->

<changeSet id="${project.parent.artifactId}-20160511-1056" author="pwangoo">
    <preConditions onFail="MARK_RAN">
        <not><tableExists tableName="il_message" /></not>
    </preConditions>
    <comment>
        Create table for il messages
    </comment>
    <createTable tableName="il_message">
        <column name="message_id" autoIncrement="true" type="int">
            <constraints nullable="false" primaryKey="true" />
        </column>
        <column name="message" type="text"></column>
        <column name="creator" type="int"></column>
        <column name="message_type" type="int"></column>
        <column name="hl7_type" type="varchar(20)"></column>
        <column name="retired" type="int"></column>
        <column name="status" type="varchar(100)" defaultValue="Success" ></column>
        <column name="source" type="varchar(50)" ></column>
        <column name="date_created" type="datetime"></column>
        <column name="uuid" type="varchar(38)"></column>
    </createTable>
    <modifySql dbms="mysql">
        <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
    </modifySql>
</changeSet>
    <!--Adding scheduled task :Set the outbox task-->
    <changeSet id="${project.parent.artifactId}-20161212-1044" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessOutboxTask'
                And name = 'Process Outbox Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Process Outbox Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Process Outbox Task" />
            <column name="description" value="Periodically Process Outbox Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessOutboxTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="649ddcae-d8d8-49b8-9394-ad7f42a0fad8" />
        </insert>
    </changeSet>
    <!--Adding scheduled task :Set the inbox task-->
    <changeSet id="${project.parent.artifactId}-20161210-1244" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessInboxTask'
                And name = 'Process Inbox Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Process Inbox Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Process Inbox Task" />
            <column name="description" value="Periodically Process Inbox Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessInboxTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="9ee3eb6a-533f-4ff8-9891-2bf97e71bab3" />
        </insert>
    </changeSet>
    <!--Adding scheduled task :Set the enrollment task-->
    <changeSet id="${project.parent.artifactId}-20161211-1144" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessEnrollmentTask'
                And name = 'Enrollment Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Enrollment Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Enrollment Task" />
            <column name="description" value="Periodically Process Enrollment Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessEnrollmentTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="c852007f-d1ab-4bf7-8fea-18e4d29e94cc" />
        </insert>
    </changeSet>
    <!--Adding scheduled task :Set the appointment task-->
    <changeSet id="${project.parent.artifactId}-20161212-1344" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessAppointmentsTask'
                And name = 'Appointment Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Appointment Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Appointment Task" />
            <column name="description" value="Periodically Process Appointment Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessAppointmentsTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="726932a0-1b04-4a72-99c3-74a25d0e77c3" />
        </insert>
    </changeSet>
    <!--Adding scheduled task :Set the ORU task-->
    <changeSet id="${project.parent.artifactId}-20161212-1444" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessORUsTask'
                And name = 'Process ORU Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Process ORU Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Process ORU Task" />
            <column name="description" value="Periodically Process ORU Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessORUsTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2017-11-28T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="e31bf937-6550-438a-82ed-f5b1a4bc167e" />
        </insert>
    </changeSet>

    <!--Adding scheduled task :Set the Orders task-->
    <changeSet id="${project.parent.artifactId}-20201102-1544" author="makombe">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessOrdersTask'
                And name = 'Process Order Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Process Order Task into 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Process Order Task" />
            <column name="description" value="Periodically Process Orders Task" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProcessOrdersTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2020-11-02T23:59:59" />
            <column name="repeat_interval" value="7200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="f38474a0-1de5-11eb-adc1-0242ac120002" />
        </insert>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20210118-1048" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="il_registration" /></not>
        </preConditions>
        <comment>
            Create table for il registration messages
        </comment>
        <createTable tableName="il_registration">
            <column name="message_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="patient_id" type="int"></column>
            <column name="message" type="text"></column>
            <column name="creator" type="int"></column>
            <column name="message_type" type="int"></column>
            <column name="hl7_type" type="varchar(20)"></column>
            <column name="retired" type="int"></column>
            <column name="status" type="varchar(100)" defaultValue="Success" ></column>
            <column name="source" type="varchar(50)" ></column>
            <column name="date_created" type="datetime"></column>
            <column name="uuid" type="varchar(38)"></column>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20210119-1138" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="il_message_archive" /></not>
        </preConditions>
        <comment>
            Create table for il messages archive
        </comment>
        <createTable tableName="il_message_archive">
            <column name="message_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="message" type="text"></column>
            <column name="creator" type="int"></column>
            <column name="message_type" type="int"></column>
            <column name="hl7_type" type="varchar(20)"></column>
            <column name="retired" type="int"></column>
            <column name="status" type="varchar(100)" defaultValue="Success" ></column>
            <column name="source" type="varchar(50)" ></column>
            <column name="date_created" type="datetime"></column>
            <column name="uuid" type="varchar(38)"></column>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20210120-0946" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="il_message_error_queue" /></not>
        </preConditions>
        <comment>
            Create table for il messages error queue
        </comment>
        <createTable tableName="il_message_error_queue">
            <column name="message_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="message" type="text"></column>
            <column name="creator" type="int"></column>
            <column name="message_type" type="int"></column>
            <column name="hl7_type" type="varchar(20)"></column>
            <column name="retired" type="int"></column>
            <column name="status" type="varchar(100)" defaultValue="Success" ></column>
            <column name="source" type="varchar(50)" ></column>
            <column name="date_created" type="datetime"></column>
            <column name="uuid" type="varchar(38)"></column>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20210121-1144" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <and>
                <columnExists tableName="il_message_error_queue" columnName="status"/>
            </and>
        </preConditions>
        <comment>
            Drop status field for update
        </comment>
        <dropColumn columnName="status" tableName="il_message_error_queue"/>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20210121-1152" author="pwangoo">
        <preConditions onFail="MARK_RAN">
               <not>
                    <columnExists tableName="il_message_error_queue" columnName="status"/>
                </not>
        </preConditions>
        <comment>
            Add back dropped status field for logging error description
        </comment>
        <addColumn tableName="il_message_error_queue">
            <column name="status" type="varchar(255)"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <!--Removing scheduled process Orders task-->
    <changeSet id="${project.parent.artifactId}-20210122-1030" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessOrdersTask'
                And name = 'Process Order Task'
            </sqlCheck>
        </preConditions>
        <comment>Deleting Process Order Task into 'schedule_task_config' table</comment>
        <delete tableName="scheduler_task_config">
            <where>name='Process Order Task'</where>
        </delete>
    </changeSet>

    <!--Removing scheduled process ORU task-->
    <changeSet id="${project.parent.artifactId}-20210122-1052" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProcessORUsTask'
                And name = 'Process ORU Task'
            </sqlCheck>
        </preConditions>
        <comment>Deleting Process ORU Task into 'schedule_task_config' table</comment>
        <delete tableName="scheduler_task_config">
            <where>name='Process ORU Task'</where>
        </delete>
    </changeSet>

    <!--Adding scheduled task :Pull Mlab results-->
    <changeSet id="${project.parent.artifactId}-20220804-0744" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.MLabViralLoadResultsPullTask'
                And name = 'Pull Mlab viral load results Task'
            </sqlCheck>
        </preConditions>
        <comment>Add task for pulling viral load results from Mlab</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Pull Mlab viral load results Task" />
            <column name="description" value="Periodically pulls viral load results from MLab" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.MLabViralLoadResultsPullTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2021-11-28T23:59:59" />
            <column name="repeat_interval" value="18000" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="0" />
            <column name="started" value="0" />
            <column name="uuid" value="2e16d6be-714b-42e3-9285-b163b1a4104b" />
        </insert>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20220804-1629" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.UshauriDirectPushTask'
                And name = 'Push messages to Ushauri server'
            </sqlCheck>
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.KenyaEmrInteropDirectPushTask'
                And name = 'OpenHIM Message Publisher'
            </sqlCheck>
        </preConditions>
        <comment>Add task for pushing messages to Ushauri receiver</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Push messages to Ushauri server" />
            <column name="description" value="Periodically pushes messages to Ushauri" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.UshauriDirectPushTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2021-11-28T23:59:59" />
            <column name="repeat_interval" value="18000" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="0" />
            <column name="started" value="0" />
            <column name="uuid" value="7351bb07-97b2-47b6-804b-c9c018c36609" />
        </insert>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20220811-1016" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="mhealth_message_outbox" /></not>
        </preConditions>
        <comment>
            Create table for mhealth message outbox
        </comment>
        <createTable tableName="mhealth_message_outbox">
            <column name="message_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="message" type="text"></column>
            <column name="creator" type="int"></column>
            <column name="message_type" type="int"></column>
            <column name="hl7_type" type="varchar(20)"></column>
            <column name="retired" type="int"></column>
            <column name="status" type="varchar(100)" defaultValue="Success" ></column>
            <column name="source" type="varchar(50)" ></column>
            <column name="date_created" type="datetime"></column>
            <column name="uuid" type="varchar(38)"></column>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20220811-1020" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="mhealth_patient_registration" /></not>
        </preConditions>
        <comment>
            Create table for mhealth registration messages
        </comment>
        <createTable tableName="mhealth_patient_registration">
            <column name="message_id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="patient_id" type="int"></column>
            <column name="message" type="text"></column>
            <column name="creator" type="int"></column>
            <column name="message_type" type="int"></column>
            <column name="hl7_type" type="varchar(20)"></column>
            <column name="retired" type="int"></column>
            <column name="status" type="varchar(100)" defaultValue="Success" ></column>
            <column name="source" type="varchar(50)" ></column>
            <column name="date_created" type="datetime"></column>
            <column name="uuid" type="varchar(38)"></column>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20220819-1034" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="il_message_error_queue" columnName="middleware"/>
            </not>
        </preConditions>
        <comment>
            Add middleware column
        </comment>
        <addColumn tableName="il_message_error_queue">
            <column name="middleware" type="varchar(50)" defaultValue="IL"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20221109-1034" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="il_message_archive" columnName="middleware" />
            </not>
        </preConditions>
        <comment>
            Add middleware column to the archive table
        </comment>
        <addColumn tableName="il_message_archive">
            <column name="middleware" type="varchar(50)" defaultValue="IL"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20221219-1034" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="mhealth_message_outbox" columnName="patient_id"/>
            </not>
        </preConditions>
        <comment>
            Add link to patient
        </comment>
        <addColumn tableName="mhealth_message_outbox">
            <column name="patient_id" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <changeSet id="${project.parent.artifactId}-20221219-1035" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="il_message_error_queue" columnName="patient_id"/>
            </not>
        </preConditions>
        <comment>
            Add link to patient
        </comment>
        <addColumn tableName="il_message_error_queue">
            <column name="patient_id" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <!--We need to easily get messages for a patient/person. The current way is to process the json payload-->
    <changeSet id="${project.parent.artifactId}-20221219-1036" author="aojwang">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="il_message" columnName="patient_id"/>
            </not>
        </preConditions>
        <comment>
            Add link to patient
        </comment>
        <addColumn tableName="il_message">
            <column name="patient_id" type="int"> <constraints nullable="true"/> </column>
        </addColumn>
    </changeSet>

    <!--Adding scheduled task :Set program discontinuation task-->
    <changeSet id="${project.parent.artifactId}-2023010101030" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ProgramDiscontinuationTask'
                And name = 'Program Discontinuation Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting program discontinuation 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Program Discontinuation Task" />
            <column name="description" value="Periodically Process Program Discontinuations" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ProgramDiscontinuationTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2023-01-01T23:59:59" />
            <column name="repeat_interval" value="21600" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="9143b4e6-16c5-11ee-be56-0242ac120002" />
        </insert>
    </changeSet>

    <!--Reuse existing structure to support additional message types: Rename mhealth_message_outbox to emr_interop_message-->
    <changeSet id="${project.parent.artifactId}-202307031030" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="mhealth_message_outbox"/>
            <not><tableExists tableName="emr_interop_message"/></not>
        </preConditions>
        <comment>
            Reuse existing structure to support additional message types: Rename mhealth_message_outbox to emr_interop_message
        </comment>
        <renameTable oldTableName="mhealth_message_outbox" newTableName="emr_interop_message"/>
    </changeSet>

    <!--Reuse existing structure to support additional message types: Rename UshauriDirectPushTask to KenyaEmrInteropDirectPushTask-->
    <changeSet id="${project.parent.artifactId}-202307030440" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.UshauriDirectPushTask'
                And name = 'Push messages to Ushauri server'
            </sqlCheck>
        </preConditions>
        <comment>Rename UshauriDirectPushTask scheduler to KenyaEmrInteropDirectPushTask</comment>
        <sql>
            UPDATE openmrs.scheduler_task_config SET schedulable_class = 'org.openmrs.module.kenyaemrIL.KenyaEmrInteropDirectPushTask',
            name = 'OpenHIM Message Publisher' where uuid = '7351bb07-97b2-47b6-804b-c9c018c36609'
        </sql>
    </changeSet>

    <!--Update start on start to yes KenyaEmrInteropDirectPushTask-->
    <changeSet id="${project.parent.artifactId}-20231101192630" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="1">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.KenyaEmrInteropDirectPushTask'
                And name = 'OpenHIM Message Publisher'
            </sqlCheck>
        </preConditions>
        <comment>Update start on start to yes of KenyaEmrInteropDirectPushTask</comment>
        <sql>
            UPDATE openmrs.scheduler_task_config SET start_on_startup = "1"
            where uuid = '7351bb07-97b2-47b6-804b-c9c018c36609'
        </sql>
    </changeSet>

    <!-- Adding scheduled task : Validate transfer out patients -->
    <changeSet id="${project.parent.artifactId}-202310100430" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.ValidateTransferOutsTasks'
                And name = 'Validate TransferOut Patients'
            </sqlCheck>
        </preConditions>
        <comment>Creating transfer outs validator task</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Validate TransferOut Patients"/>
            <column name="description" value="Periodically Validates TransferOut Patients"/>
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.ValidateTransferOutsTasks"/>
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss"/>
            <column name="start_time" valueDate="2023-07-04T23:59:59"/>
            <column name="repeat_interval" value="43200"/>
            <column name="date_created" valueDate="CURRENT_TIMESTAMP"/>
            <column name="created_by" value="1"/>
            <column name="start_on_startup" value="1"/>
            <column name="started" value="0"/>
            <column name="uuid" value="5fdedec8-1b32-11ee-be56-0242ac120002"/>
        </insert>
    </changeSet>
    <changeSet id="${project.parent.artifactId}-20230829-0001" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <not><tableExists tableName="expected_transfer_ins" /></not>
        </preConditions>
        <comment>
            Create table for expected TI patients
        </comment>
        <createTable tableName="expected_transfer_ins">
            <column name="id" autoIncrement="true" type="int">
                <constraints nullable="false" primaryKey="true" />
            </column>
            <column name="patient_id" type="int"/>
            <column name="first_name" type="varchar(255)" />
            <column name="middle_name" type="varchar(255)" />
            <column name="last_name" type="varchar(255)" />
            <column name="sex" type="varchar(10)" />
            <column name="birth_date" type="datetime" />
            <column name="nupi" type="varchar(100)" />
            <column name="transfer_out_date" type="datetime"/>
            <column name="transfer_out_facility" type="text"/>
            <column name="appointment_date" type="datetime"/>
            <column name="effective_discontinuation_date" type="datetime"/>
            <column name="to_acceptance_date" type="datetime"/>
            <column name="referral_status" type="varchar(255)"/>
            <column name="patient_summary" type="text"/>
            <column name="service_type" type="varchar(50)" />
            <column name="creator" type="int"/>
            <column name="date_created" type="datetime"/>
            <column name="date_changed" type="datetime" />
            <column name="uuid" type="varchar(38)"/>
            <column name="voided" type="int"/>
        </createTable>
        <modifySql dbms="mysql">
            <append value="ENGINE=INNODB CHARSET=UTF8 COLLATE utf8_unicode_ci"/>
        </modifySql>
    </changeSet>

    <!-- Add service_type field to the expected_transfer_ins table -->
    <changeSet author="pwangoo" id="${project.parent.artifactId}-20230823-0002">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="expected_transfer_ins"/>
            <not>
                <columnExists columnName="service_type" tableName="expected_transfer_ins"/>
            </not>
        </preConditions>
        <comment>Adding service_type column</comment>
        <addColumn tableName="expected_transfer_ins" >
            <column name="service_type"
                    type="varchar(50)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    <!-- Add service_type field to the expected_transfer_ins table -->
    <changeSet author="pwangoo" id="${project.parent.artifactId}-20230831-0003">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="expected_transfer_ins"/>
            <not>
                <columnExists columnName="first_name" tableName="expected_transfer_ins"/>
             </not>
             <not>
                <columnExists columnName="middle_name" tableName="expected_transfer_ins"/>
             </not>
            <not>
                <columnExists columnName="last_name" tableName="expected_transfer_ins"/>
            </not>
            <not>
                <columnExists columnName="sex" tableName="expected_transfer_ins"/>
            </not>
            <not>
                <columnExists columnName="birth_date" tableName="expected_transfer_ins"/>
            </not>
            <not>
                <columnExists columnName="nupi" tableName="expected_transfer_ins"/>
            </not>
        </preConditions>
        <comment>Adding first_name,middle_name,last_name,sex,birth_date,nupi columns</comment>
        <addColumn tableName="expected_transfer_ins" >
            <column name="first_name"
                    type="varchar(255)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="expected_transfer_ins" >
            <column name="middle_name"
                    type="varchar(255)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="expected_transfer_ins" >
            <column name="last_name"
                    type="varchar(255)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="expected_transfer_ins" >
            <column name="sex"
                    type="varchar(10)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="expected_transfer_ins" >
            <column name="birth_date"
                    type="datetime" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <addColumn tableName="expected_transfer_ins" >
            <column name="nupi"
                    type="varchar(100)" >
                <constraints nullable="true" />
            </column>
        </addColumn>
    </changeSet>
    <!--Adding scheduled task :Set PullExpectedTransferInsTask-->
    <changeSet id="${project.parent.artifactId}-202310100930" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.PullExpectedTransferInsTask'
                And name = 'Expected Transfer Ins Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting Transfer Ins Task to 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Expected Transfer Ins Task" />
            <column name="description" value="Periodically Fetch expected transfer ins" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.PullExpectedTransferInsTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2023-01-01T23:59:59" />
            <column name="repeat_interval" value="43200" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="1" />
            <column name="uuid" value="9143b4e6-16c5-11ee-be56-0342ac120002" />
        </insert>
    </changeSet>
    <!-- Add service_type field to the expected_transfer_ins table -->
    <changeSet author="jecihjoy" id="${project.parent.artifactId}-20231010-3453">
        <preConditions onFail="MARK_RAN">
            <tableExists tableName="expected_transfer_ins"/>
            <not>
                <columnExists columnName="date_changed" tableName="expected_transfer_ins"/>
            </not>
            <columnExists columnName="retired" tableName="expected_transfer_ins"/>
        </preConditions>
        <comment>Adding date_changed column, renaming retired to voided</comment>
        <addColumn tableName="expected_transfer_ins" >
            <column name="date_changed"
                    type="datetime" >
                <constraints nullable="true" />
            </column>
        </addColumn>
        <sql>
            ALTER TABLE expected_transfer_ins RENAME COLUMN retired TO voided;
        </sql>
    </changeSet>
    <!--Adding scheduled task :Set SyncShrServedPatientsTask task-->
    <!-- <changeSet id="${project.parent.artifactId}-20231000011630" author="jecihjoy">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.SyncShrServedPatientsTask'
                And name = 'SHR Sync Task'
            </sqlCheck>
        </preConditions>
        <comment>Inserting SHR Sync Task to 'schedule_task_config' table</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="SHR Sync Task" />
            <column name="description" value="Periodically sync referral clients with shr" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.SyncShrServedPatientsTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2023-01-01T23:59:59" />
            <column name="repeat_interval" value="21600" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="1" />
            <column name="uuid" value="36bb93cc-67bf-11ee-8c99-0242ac120002" />
        </insert>
    </changeSet> -->
    <changeSet id="${project.parent.artifactId}-20231004-1453" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.DmiDirectPushTask'
                And name = 'Push messages to DMI server'
            </sqlCheck>
        </preConditions>
        <comment>Add task for pushing messages to DMI receiver</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Push messages to DMI server" />
            <column name="description" value="Periodically pushes messages to DMI" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.DmiDirectPushTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2024-03-01T23:59:59" />
            <column name="repeat_interval" value="3600" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0" />
            <column name="uuid" value="a63b35e1-9b4d-4cb9-8a26-4fbf33b353e5" />
        </insert>
    </changeSet>
    <changeSet id="${project.parent.artifactId}-20240301-1224" author="pwangoo">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM scheduler_task_config
                WHERE schedulable_class = 'org.openmrs.module.kenyaemrIL.VisualizationMetricsPushTask'
                And name = 'Push messages to Visualization server'
            </sqlCheck>
        </preConditions>
        <comment>Add task for pushing messages to Visualization server</comment>
        <insert tableName="scheduler_task_config">
            <column name="name" value="Push messages to Visualization server" />
            <column name="description" value="Periodically pushes messages to Visualization server" />
            <column name="schedulable_class" value="org.openmrs.module.kenyaemrIL.VisualizationMetricsPushTask" />
            <column name="start_time_pattern" value="MM/dd/yyyy HH:mm:ss" />
            <column name="start_time" valueDate="2024-03-16T23:59:59" />
            <column name="repeat_interval" value="3600" />
            <column name="date_created" valueDate="CURRENT_TIMESTAMP" />
            <column name="created_by" value="1" />
            <column name="start_on_startup" value="1" />
            <column name="started" value="0"/>
            <column name="uuid" value="9f883bf3-447a-4c7e-aed3-c77fe7dc755a" />
        </insert>
    </changeSet>
</databaseChangeLog>
